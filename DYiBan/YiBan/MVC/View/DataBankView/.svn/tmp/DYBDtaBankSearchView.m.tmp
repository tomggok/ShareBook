//
//  DYBDtaBankSearchView.m
//  DYiBan
//
//  Created by tom zeng on 13-8-9.
//  Copyright (c) 2013年 ZzL. All rights reserved.
//

#import "DYBDtaBankSearchView.h"
#import "DYBSideSwipeViewController.h"
#import "DYBDataBankListCell.h"


@implementation DYBDtaBankSearchView{

    NSMutableArray *arrTag;
    NSMutableArray *arrName;
    NSMutableArray *arrContent;
   

    BOOL isNETSearch;
    DYBSideSwipeViewController *sideController;
    
    NSMutableArray *arraySearchResult;
    NSMutableDictionary *dictSearchResult;
}
@synthesize arrayResourcesList;
@synthesize tbDataBank,searchbar = _searchbar;

DEF_SIGNAL(FIRSTTOUCH)
DEF_SIGNAL(RECOVERBAR)

- (id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        // Initialization code
        [self initView:frame];
    }
    return self;
}

-(void)initView:(CGRect)frame{

    isNETSearch = NO;
    _searchbar = [[DragonUISearchBar alloc]initWithFrame:CGRectMake(0.0f, 0.0f, CGRectGetWidth(frame), CGRectGetHeight(frame)) backgroundColor:[UIColor clearColor] placeholder:@"文件名/分类名/标签名" isHideOutBackImg:NO isHideLeftView:NO];
    for (UIView *subview in [_searchbar subviews]) {
        if ([subview isKindOfClass:NSClassFromString(@"UISearchBarBackground")])
        {
            [subview removeFromSuperview];
        }else if ([subview isKindOfClass:NSClassFromString(@"UISearchBarTextField")]) {
            [(UITextField *)subview setBackground:[UIImage imageNamed:@"top_searchbar.png"]];
            
        }else if ([subview isKindOfClass:[UIButton class]]){
        
            DLogInfo(@"subview === %@",subview);
            [(UIButton *)subview setImage:[UIImage imageNamed:@"btn_search_cancel_def" ] forState:UIControlStateNormal];
            [(UIButton *)subview setImage:[UIImage imageNamed:@"btn_search_cancel_high" ] forState:UIControlStateHighlighted];
            [subview setBackgroundColor:[UIColor clearColor]];
        
        }
    }
    [_searchbar setBackgroundColor:[UIColor colorWithRed:248/255.0f green:248/255.0f blue:248/255.0f alpha:1.0f]];
    [_searchbar setUserInteractionEnabled:YES];
    [self addSubview:_searchbar];
//    [_searchbar release]; // 异常 报错
    
    tbDataBank = [[DragonUITableView alloc]initWithFrame:CGRectMake(0.0f, _searchbar.frame.origin.y + _searchbar.frame.size.height , 320.0f, self.frame.size.height - _searchbar.frame.origin.y - _searchbar.frame.size.height)];
    [tbDataBank setBackgroundColor:[UIColor clearColor]];
    [tbDataBank setHidden:YES];
    [self addSubview:tbDataBank];
    [tbDataBank setSeparatorColor:[UIColor clearColor]];
    
    [tbDataBank release];
    
    arraySearchResult = [[NSMutableArray alloc]init];
    dictSearchResult = [[NSMutableDictionary alloc]init];

    
    
}

-(void)showSpeLine{

    if (arraySearchResult.count > 0) {
        
        [tbDataBank setSeparatorColor:[UIColor colorWithRed:238/255.0f green:238/255.0f blue:238/255.0f alpha:1.0f]];
    }

}

-(void)hideSpeLine{
    
    [tbDataBank setSeparatorColor:[UIColor clearColor]];

}
-(void)handleViewSignal_DragonUISearchBar:(DragonViewSignal *)signal{
    
    
    if ([signal is:[DragonUISearchBar BEGINEDITING]]) {
        
        [arraySearchResult removeAllObjects]; //清除内容
        
        DragonUISearchBar *obj = (DragonUISearchBar *)[signal object];
        [obj setShowsCancelButton:YES];
        
        [tbDataBank setHidden:NO];
        [tbDataBank reloadData];
        
        for(id cc in [_searchbar subviews])
        {
            if([cc isKindOfClass:[UIButton class]])
            {
                UIButton *btn = (UIButton *)cc;
                [btn setTitle:@""  forState:UIControlStateNormal];
                [btn setBackgroundColor:[UIColor clearColor]];
                [btn setFrame:CGRectMake(-10, 44, 100.0, 100)];
                [btn.titleLabel setShadowColor:[UIColor clearColor]];
                [btn.titleLabel setShadowOffset:CGSizeMake(0.0f, 0.0f)];
                [btn setBackgroundImage:[UIImage imageNamed:@"btn_search_cancel_def"] forState:UIControlStateNormal];
                [btn setBackgroundImage:[UIImage imageNamed:@"btn_search_cancel_high"] forState:UIControlStateHighlighted];
                btn.layer.borderColor=[UIColor clearColor].CGColor;
                btn.layer.borderWidth=0.6;
            }
        }
        
        [self sendViewSignal:[DYBDtaBankSearchView FIRSTTOUCH] withObject:nil from:self];

        
        [tbDataBank setBackgroundColor:[UIColor clearColor]];
        
    }else if([signal is:[DragonUISearchBar CANCEL]]){
        
        DragonUISearchBar *obj = (DragonUISearchBar *)[signal object];
        [obj resignFirstResponder];
        [obj setShowsCancelButton:NO];
        [self sendViewSignal:[DYBDtaBankSearchView RECOVERBAR] withObject:nil from:self];
    }else if([signal is:[DragonUISearchBar SEARCH]]){
        
        DragonUISearchBar *obj = (DragonUISearchBar *)[signal object];
        [obj resignFirstResponder];
        [obj setShowsCancelButton:YES];
        [self addOBjToArray:signal];
        
        [tbDataBank reloadData];
        
        
    }else if ([signal is:[DragonUISearchBar CHANGEWORD]]){
    
        [self addOBjToArray:signal];
        
    }
    
    
}

-(void)addOBjToArray:(DragonViewSignal *)signal{

    NSString *obj = (NSString *)[signal object];
    for (NSDictionary *dict in arrayResourcesList) {
        NSString *title = [dict objectForKey:@"title"];
        NSRange rang = [title rangeOfString:obj];
        if (rang.length >  0 ) { // 加强判断 有风险
            
            if (![arraySearchResult containsObject:dict] ) {
                [arraySearchResult addObject:dict];
            }
        }
    }
<<<<<<< .mine
    if (obj.length > 0) {
=======
    if (obj.text && obj.text.length > 0) {
>>>>>>> .r8361
        
        [self showSpeLine];
    }else{
        [arraySearchResult removeAllObjects];
        [self hideSpeLine];
    }
    
    [tbDataBank reloadData];

}

- (void)handleViewSignal_DragonUITableView:(DragonViewSignal *)signal{
    
    
    if ([signal is:[DragonUITableView TABLENUMROWINSEC]])//numberOfRowsInSection
    {
        NSNumber *s = [NSNumber numberWithInteger:arraySearchResult.count];
        [signal setReturnValue:s];
        
    }else if ([signal is:[DragonUITableView TABLENUMOFSEC]])//numberOfSectionsInTableView
    {
        NSNumber *s = [NSNumber numberWithInteger:1];
        [signal setReturnValue:s];
        
    }
    else if ([signal is:[DragonUITableView TABLEHEIGHTFORROW]])//heightForRowAtIndexPath
    {
        
        
        
        [signal setReturnValue:[NSNumber numberWithInteger:CELLHIGHT]];
    }
    else if ([signal is:[DragonUITableView TABLETITLEFORHEADERINSECTION]])//titleForHeaderInSection
    {
        [signal setReturnValue:nil];
        
    }
    else if ([signal is:[DragonUITableView TABLEVIEWFORHEADERINSECTION]])//viewForHeaderInSection
    {
        [signal setReturnValue:nil];
        
    }//
    else if ([signal is:[DragonUITableView TABLETHEIGHTFORHEADERINSECTION]])//heightForHeaderInSection
    {
        [signal setReturnValue:[NSNumber numberWithFloat:0.0]];
    }
    else if ([signal is:[DragonUITableView TABLECELLFORROW]])//cell
    {
        NSDictionary *dict = (NSDictionary *)[signal object];
     
        NSIndexPath *indexPath = [dict objectForKey:@"indexPath"];
        
        
        DYBDataBankListCell *cell = [[DYBDataBankListCell alloc]initWithFrame:CGRectMake(0.0f, 0.0f, 320.0f, CELLHIGHT)];
        [cell initViewCell_dict:[arraySearchResult objectAtIndex:indexPath.row]];
        [cell setSelectionStyle:UITableViewCellSelectionStyleNone];
        if (indexPath.row%2 == 0) {
            [cell.cellBackground setBackgroundColor:[UIColor colorWithRed:252/255.0f green:252/255.0f blue:252/255.0f alpha:1.0f]];
        }else{
            
            [cell.cellBackground setBackgroundColor:[UIColor colorWithRed:248/255.0f green:248/255.0f blue:248/255.0f alpha:1.0f]];
            
        }
        
        //        [cell.cellBackground setBackgroundColor:[UIColor redColor]];
        //        [cell setBackgroundColor:[UIColor yellowColor]];
        [signal setReturnValue:cell];
        
        
    }else if ([signal is:[DragonUITableView TABLEDIDSELECT]])//选中cell
    {
        
        NSDictionary *dict = (NSDictionary *)[signal object];
        [self performSelector:@selector(cancelSelect) withObject:nil afterDelay:0.5];
     
    }else if ([signal is:[DragonUITableView TABLESCROLLVIEWDIDENDDRAGGING]])//滚动停止
    {
        
        switch ([tbDataBank tableViewDidEndDragging]) {
            case RETURNREFRESH://下拉刷新
            {
                //                DLogInfo(@"coming new");
            }
                break;
            case RETURNLOADMORE://加载更多
            {
                //                DLogInfo(@"more");
                
            }
                break;
        }
    }else if ([signal is:[DragonUITableView TABLESCROLLVIEWDIDSCROLL]])
    {
        [tbDataBank tableViewDidDragging];
        
        if (_searchbar) {
            
            [_searchbar resignFirstResponder];
            [_searchbar setShowsCancelButton:YES];
        }
        
    }
    else if ([signal is:[DragonUITableView TABLESCROLLVIEWDIDENDDRAGGING]])
    {
        DLogInfo(@"1111");
        
    }
    
    
}

-(void)cancelSelect{
    
    [tbDataBank deselectRowAtIndexPath:[tbDataBank indexPathForSelectedRow] animated:YES];

}



#pragma  Operation search bar 

-(void)setSearchFirstResponder{

    [_searchbar resignFirstResponder];
    
}

-(void)isShowCanelButton:(BOOL)key{

    [_searchbar setShowsCancelButton:key];
}


#pragma UISearchDelegate Function


- (void)dealloc
{
    
    [super dealloc];
}

@end
