//
//  DYBSettingViewController.m
//  DYiBan
//
//  Created by Song on 13-8-9.
//  Copyright (c) 2013年 ZzL. All rights reserved.
//

#import "DYBSettingViewController.h"
#import "DYBSettingMessageViewController.h"
#import "DYBSettingImageViewController.h"
#import "DYBDataBaseViewController.h"
#import "DYBSynchroViewController.h"
#import "Dragon_UIAlertView.h"
#import "DYBSetButton.h"
#import "DYBScroller.h"
#import "DYBHelp-protocolViewController.h"
#import "version.h"
#import "Dragon_Device.h"
#import "DYBSettingSendMessViewController.h"
#import "DYBDataBankShotView.h"
#import "DYBLoginViewController.h"

#import "DYBUITabbarViewController.h"
#import "DYBGifView.h"
#import "UserSettingMode.h"
@interface DYBSettingViewController () {
    
    version *ver;
    
    DYBDataBankShotView *showView;//推出按钮
    DYBSetButton *settingButton[9];
    DYBGifView *dataView;
}

@end

@implementation DYBSettingViewController
@synthesize showTag = _showTag;
DEF_SIGNAL(MUSICBUTTON)//音乐按钮
DEF_SIGNAL(LOGOUTBUTTON)//退出系统
DEF_SIGNAL(TOUCHBUTTON)//点击消息

- (void)handleViewSignal_DragonViewController:(DragonViewSignal *)signal
{
    if ([signal is:[DragonViewController WILL_APPEAR]])
    {
        [self.rightButton setHidden:YES];
        [self.headview setTitle:@"设置"];
    }else if ([signal is:[DragonViewController CREATE_VIEWS]])
    {
        
        DragonUIScrollView *scroll = [[DragonUIScrollView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT)];
        [scroll setShowsVerticalScrollIndicator:NO];
        [self.view addSubview:scroll];
        RELEASE(scroll);
        
        //版本号
        NSString *str = [[[NSBundle mainBundle] infoDictionary] objectForKey:(NSString *)kCFBundleVersionKey];
        NSString *version = [@"" stringByAppendingFormat:@"版本检测(当前版本：%@)",str];
        NSArray *textArray = @[@"消息提醒",@"音效",@"图片",@"同步",@"资料库",@"意见反馈",@"帮助",@"用户协议",version];
        
        for (int i = 0; i < 9; i++) {
            
            if (i < 4) {
                
                if (i == 1) {
                    
                    settingButton[i] = [[DYBSetButton alloc]initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*i, BUTTONWIDTH, BUTTONHEIGHT) labelText:[textArray objectAtIndex:i] isArrow:YES type:0];
                    settingButton[i].switchButton.tag = 0;
                    
                    [settingButton[i] setStatus:SHARED.currentUserSetting.sound];
                    
                }else {
                    
                    settingButton[i] = [[DYBSetButton alloc]initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*i, BUTTONWIDTH, BUTTONHEIGHT) labelText:[textArray objectAtIndex:i] isArrow:NO type:0];
                }
                
            }else if (i == 4) {
                
                settingButton[i] = [[DYBSetButton alloc]initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*i+OFFSETFROM, BUTTONWIDTH, BUTTONHEIGHT) labelText:[textArray objectAtIndex:i] isArrow:NO type:0];
                
            }else if (i == 8){
                
                settingButton[i] = [[DYBSetButton alloc]initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*i+OFFSETFROM*3, BUTTONWIDTH, BUTTONHEIGHT) labelText:[textArray objectAtIndex:i] isArrow:YES type:1];
            }else {
                
                settingButton[i] = [[DYBSetButton alloc]initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*i+OFFSETFROM*2, BUTTONWIDTH, BUTTONHEIGHT) labelText:[textArray objectAtIndex:i] isArrow:NO type:0];
                
            }
            
            settingButton[i].tag = i;
            [settingButton[i] addSignal:[DYBSettingViewController TOUCHBUTTON] forControlEvents:UIControlEventTouchUpInside];
            
            [scroll addSubview:settingButton[i]];
            RELEASE(settingButton[i]);
            
        }
        
        //退出系统
        DragonUIButton *logoutButton = [[DragonUIButton alloc] initWithFrame:CGRectMake(OFFSETFROM, OFFSETFROM+self.headHeight+(BUTTONHEIGHT-1)*9+60, BUTTONWIDTH, BUTTONHEIGHT)];
        [logoutButton addSignal:[DYBSettingViewController LOGOUTBUTTON] forControlEvents:UIControlEventTouchUpInside];
        logoutButton.titleLabel.font = [DYBShareinstaceDelegate DYBFoutStyle:20];
        [logoutButton setTitle:@"退出帐号" forState:UIControlStateNormal];
        logoutButton.backgroundColor = [UIColor redColor];
        [scroll addSubview:logoutButton];
        RELEASE(logoutButton);
        
        scroll.contentSize = CGSizeMake(SCREEN_WIDTH, [settingButton[8] getLowy]+45+logoutButton.frame.size.height);
        
    }
}

#pragma makr -
#pragma mark - back button signal
- (void)handleViewSignal_DYBBaseViewController:(DragonViewSignal *)signal
{
    if ([signal is:[DYBBaseViewController BACKBUTTON]])
    {
        DYBUITabbarViewController *dync = [DYBUITabbarViewController sharedInstace];
        [dync scrollMainView:1];
    }
    
}

- (void)handleViewSignal_DYBSetButton:(DragonViewSignal *)signal {
    
    NSDictionary *dict = (NSDictionary *)[signal object];
    DYBSwitchButton *btn = [dict objectForKey:@"switchButton"];
    NSString *onOff = [dict objectForKey:@"isOn"];
    
    [btn setOn:[onOff boolValue] animated:YES];
    [SHARED.currentUserSetting setSound:[onOff boolValue]];
        
}


#pragma mark- 按钮点击
- (void)handleViewSignal_DYBSettingViewController:(DragonViewSignal *)signal
{
    DragonUIButton *btn = signal.source;
    
    if ([signal is:[DYBSettingViewController MUSICBUTTON]])
    {
        if (btn.tag == 0) {
            
            [btn setImage:[UIImage imageNamed:@"switch_on"] forState:UIControlStateNormal];
            btn.tag = 1;
            
        }else {
            
            [btn setImage:[UIImage imageNamed:@"switch_off"] forState:UIControlStateNormal];
            btn.tag = 0;
            
        }
    }
    if ([signal is:[DYBSettingViewController TOUCHBUTTON]])
    {
        switch (btn.tag) {
            case 0:{
                DYBSettingMessageViewController *vc = [[DYBSettingMessageViewController alloc] init];
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);;
                }
                break;
            case 1:
                break;
            case 2:{
                DYBSettingImageViewController *vc = [[DYBSettingImageViewController alloc] init];
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);
            }
                break;
            case 3:{
                DYBSynchroViewController *vc = [[DYBSynchroViewController alloc] init];
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);
            }
                break;
            case 4:{
                DYBDataBaseViewController *vc = [[DYBDataBaseViewController alloc] init];
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);
            }
                break;
            case 5: {
                DYBSettingSendMessViewController *vc = [[DYBSettingSendMessViewController alloc] init];
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);
            }
                break;
            case 6:
            case 7:{
                DYBHelp_protocolViewController *vc = [[DYBHelp_protocolViewController alloc] init];
                
                if (btn.tag == 6) {
                    
                    [vc setTag:0];
                    [vc setTle:@"帮助"];
                    
                }else {
                    
                    [vc setTag:1];
                    [vc setTle:@"用户协议"];
                    
                }
                
                [self.drNavigationController pushViewController:vc animated:YES];
                RELEASE(vc);
            
            }
                break;
            case 8:{
            
                [DYBShareinstaceDelegate addConfirmViewTitle:@"ggg" MSG:@"ddddddd" targetView:APPDELEGATE.window targetObj:self btnType:BTNTAG_DEL];
                
//                if (![DragonDevice hasInternetConnection]){
//                    DLogInfo(@"确定是否网络连接");
//                    return;
//                }
//                DragonRequest *request = [DYBHttpMethod site_version:YES receive:self];
//                [request setTag:1];
                if (![DragonDevice hasInternetConnection]){
                    DLogInfo(@"确定是否网络连接");
                    return;
                }
                
                NSData *localData = [NSData dataWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@"yb_loading_small" ofType:@"gif"]];
                
                dataView = [[DYBGifView alloc] initWithFrame:CGRectMake(([settingButton[8] getWidth]-30)/2,([settingButton[8] getHeight]-6)/2 , 60/2, 12/2) data:localData];
                settingButton[8].textLabel.hidden = YES;
                [settingButton[8] addSubview:dataView];
                
                [NSTimer scheduledTimerWithTimeInterval:1.1f target:self selector:@selector(site_version) userInfo:nil repeats:NO];
                

            }
                break;
            default:
                break;
        }
        
    }
    
    
    if ([signal is:[DYBSettingViewController LOGOUTBUTTON]])
    {

//        [self setShotView:showView type:905 tag:1 string:@"真的要退出？" frame:APPDELEGATE.window.bounds];
//        [DYBShareinstaceDelegate addConfirmViewTitle:@"ggg" MSG:@"ddddddd" targetView:APPDELEGATE.window targetObj:self btnType:BTNTAG_DEL];
        

        [DYBShareinstaceDelegate addConfirmViewTitle:@"" MSG:@"真的要退出？" targetView:APPDELEGATE.window targetObj:self btnType:BTNTAG_DEL];
        _showTag = 1;

    }
    
    
}

- (void)site_version {
    
    DragonRequest *request = [DYBHttpMethod site_version:YES receive:self];
    [request setTag:1];
}


-(void)handleViewSignal_DYBDataBankShotView:(DragonViewSignal *)signal{
    
    if (_showTag == 1) {
        if ([signal is:[DYBDataBankShotView RIGHT]]) {
            
            if (![DragonDevice hasInternetConnection]){
                DLogInfo(@"确定是否网络连接");
                return;
            }
            DragonRequest *request = [DYBHttpMethod user_security_logout:YES receive:self];
            [request setTag:2];
            
        }
    }
    
    if (_showTag == 2) {
        
        if ([signal is:[DYBDataBankShotView RIGHT]]) {
            
           [[UIApplication sharedApplication] openURL:[NSURL URLWithString:[ver url]]];
            
        }
    }

    if (_showTag == 3) {
        
        if ([signal is:[DYBDataBankShotView RIGHT]]) {
            
        }
    }


}


#pragma mark- HTTP
- (void)handleRequest:(DragonRequest *)request receiveObj:(id)receiveObj
{
    if ([request succeed])
    {
        if (request.tag == 1) {
    
            JsonResponse *response = (JsonResponse *)receiveObj;
            
//            [version JSONReflection:[[response data] objectForKey:@"version"]];
            
            
            
            DLogInfo(@"=========版本号＝＝＝＝%@",[response data]);
            ver = [version JSONReflection:[response data]];
            
            DLogInfo(@"=========版本号＝＝＝＝%@",ver.version_code);
            if (dataView) {
                [dataView removeFromSuperview];
                dataView = nil;
            }
            
            settingButton[8].textLabel.hidden = NO;
            
            if ([response response] ==khttpsucceedCode)
            {
                [DYBShareinstaceDelegate addConfirmViewTitle:@"" MSG:@"你的版本是最新版" targetView:APPDELEGATE.window targetObj:self btnType:BTNTAG_DEL];
                _showTag = 3;
                
            }else if ([response response] ==khttpNeedUpdateCode)
            {
                [DYBShareinstaceDelegate addConfirmViewTitle:@"" MSG:[@"" stringByAppendingFormat:@"检测到新版本%@是否更新？",ver.version] targetView:APPDELEGATE.window targetObj:self btnType:BTNTAG_DEL];
                _showTag = 2;
            }
        }
        
        if (request.tag == 2) {
            
            JsonResponse *response = (JsonResponse *)receiveObj;
            
            //*退出清理数据*/
            [SHARED cleanValue];
            [[DYBUITabbarViewController sharedInstace] clearSelf];
            
            DLogInfo(@"%@",[response data]);
            [self.drNavigationController popToRootViewControllerAnimated:YES];
            
        }
        
    }
    
}

@end